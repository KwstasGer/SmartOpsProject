@model SmartOps.Controllers.DashboardVm
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@{
    ViewData["Title"] = "Dashboard";
}

<h2>Dashboard</h2>

<ul class="nav nav-tabs" id="dashTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="top-tab" data-bs-toggle="tab" data-bs-target="#top" type="button" role="tab">
            Top 5 Πελάτες
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="sales-tab" data-bs-toggle="tab" data-bs-target="#sales" type="button" role="tab">
            Πωλήσεις @Model.Year
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="items-tab" data-bs-toggle="tab" data-bs-target="#items" type="button" role="tab">
            Top 5 Προϊόντα
        </button>
    </li>
</ul>

<div class="tab-content mt-3">
    <!-- Tab 1: Top 5 Πελάτες -->
    <div class="tab-pane fade show active" id="top" role="tabpanel">
        <table class="table table-sm table-striped align-middle">
            <thead>
                <tr>
                    <th style="width:5%;">#</th>
                    <th>Πελάτης</th>
                    <th class="text-end">Ποσό</th>
                </tr>
            </thead>
            <tbody>
                @if (Model.TopCustomers.Any())
                {
                    var idx = 1;
                    foreach (var row in Model.TopCustomers)
                    {
                        <tr>
                            <td>@idx</td>
                            <td>@row.CustomerName</td>
                            <td class="text-end">@row.Amount.ToString("N2")</td>
                        </tr>
                        idx++;
                    }
                }
                else
                {
                    <tr><td colspan="3" class="text-muted">Δεν βρέθηκαν δεδομένα.</td></tr>
                }
            </tbody>
        </table>
    </div>

    <!-- Tab 2: Πωλήσεις -->
    <div class="tab-pane fade" id="sales" role="tabpanel">
        <div class="card">
            <div class="card-body">
                <h5>Μηνιαίες Πωλήσεις (@Model.Year)</h5>
                <canvas id="salesChart" height="90"></canvas>
            </div>
        </div>
    </div>

    <!-- Tab 3: Top 5 Προϊόντα (σε ποσότητα) -->
    <div class="tab-pane fade" id="items" role="tabpanel">
        <table class="table table-sm table-striped align-middle">
            <thead>
                <tr>
                    <th style="width:5%;">#</th>
                    <th>Είδος</th>
                    <th class="text-end">Ποσότητα</th>
                </tr>
            </thead>
            <tbody>
                @if (Model.TopItems != null && Model.TopItems.Any())
                {
                    var idx = 1;
                    foreach (var row in Model.TopItems)
                    {
                        <tr>
                            <td>@idx</td>
                            <td>@row.ItemCode - @row.ItemDescription</td>
                            <td class="text-end">@row.Quantity.ToString("N2")</td>
                        </tr>
                        idx++;
                    }
                }
                else
                {
                    <tr><td colspan="3" class="text-muted">Δεν βρέθηκαν πωλήσεις προϊόντων.</td></tr>
                }
            </tbody>
        </table>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        (() => {
          const data = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.SalesByMonth));
          const ctx = document.getElementById('salesChart');
          if (ctx) {
            new Chart(ctx, {
              type: 'bar',
              data: {
                labels: ['Ιαν', 'Φεβ', 'Μαρ', 'Απρ', 'Μαι', 'Ιουν', 'Ιουλ', 'Αυγ', 'Σεπ', 'Οκτ', 'Νοε', 'Δεκ'],
                datasets: [{
                  label: 'Πωλήσεις (€)',
                  data: data
                }]
              },
              options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true } }
              }
            });
          }
        })();
    </script>
}
